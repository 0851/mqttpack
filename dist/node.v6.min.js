"use strict";function e(r){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(r)}function r(e,r,t){return r in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function t(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function n(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function o(e,r,t){return r&&n(e.prototype,r),t&&n(e,t),e}function a(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:4;if(t>=8)throw new Error("Does not support high 8 bits");return e*Math.pow(2,t)|r}function i(e,r){return(e&Math.pow(2,r))>0?1:0}function s(e,r){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=Math.pow(2,t)-1;if(r[e]>n||r[e]<0)throw new Error("".concat(e," must be greater than zero and less than ").concat(n));return!0}Object.defineProperty(exports,"__esModule",{value:!0});var u=new RegExp("[\\xEF\\xBB\\xBF]","g");function c(e,r){if(r&&(e=e.replace(u,"\ufeff"),u.lastIndex=0),/[\u0000\u0001-\u001F\u007F-\u009F]/.test(e))throw new Error("Invalid TypePacket Can't contain u0000 u0001-u001F u007F-u009F, ".concat(e));return e}var f=function(){function e(r){t(this,e),this.buf=r,this.pos=0}return o(e,[{key:"peek",value:function(){return this.buf[this.pos]}},{key:"peekMultiple",value:function(e){return e?this.buf.slice(this.pos,this.pos+e):this.buf.slice(this.pos)}},{key:"index",value:function(){return this.pos}},{key:"multiple",value:function(e){var r=this.peekMultiple(e);return this.pos=this.pos+r.length,r}},{key:"multipleForce",value:function(e){var r=this.peekMultiple(e);if(r.length!==e)throw new Error("packet length error");return this.pos=this.pos+r.length,r}},{key:"readForce",value:function(){var e=this.peek();if(void 0===e)throw new Error("packet error can not read");return this.pos++,e}},{key:"read",value:function(){var e=this.peek();return void 0!==e&&this.pos++,e}},{key:"readUInt16BE",value:function(){var e=this.buf.readUInt16BE(this.pos);return this.pos=this.pos+2,e}},{key:"readUInt32BE",value:function(){var e=this.buf.readUInt32BE(this.pos);return this.pos=this.pos+4,e}},{key:"readBinaryBuf",value:function(){var e=this.buf.readUInt16BE(this.pos),r=this.pos+2+e,t=this.buf.slice(this.pos+2,r);return this.pos=r,t}},{key:"readVarInt",value:function(e){for(var r=0,t=this.pos;;){var n=this.buf[t],o=i(n,7);if(r|=(127&n)*Math.pow(2,7*(t-this.pos)),t++,!o)break}if(void 0!==e&&t-this.pos>e)throw new Error("Malformed Remaining Length max ".concat(e));return this.pos=t,r}},{key:"readUTF8",value:function(){var e=this.buf.readUInt16BE(this.pos),r=this.pos+2+e,t=this.buf.slice(this.pos+2,r).toString("utf8");return t=c(t,!0),this.pos=r,t}}]),e}(),l=function(){function e(){t(this,e),this.bodies=[]}return o(e,[{key:"result",value:function(e){var r=this.byteLength(),t=this.writeVarIntAsArray(r),n=Buffer.allocUnsafe(1+t.length+r);n.writeUInt8(e),this._copyVarInt(n,t,1);for(var o=1+t.length,a=this.bodies,i=a.length,s=0;s<i;s++){var u=a[s],c=u.type,f=u.value,l=u.len;"varint"===c&&f instanceof Array&&this._copyVarInt(n,f,o),"uint16"===c&&"number"==typeof f&&n.writeUInt16BE(f,o),"uint32"===c&&"number"==typeof f&&n.writeUInt32BE(f,o),"utf8"===c&&"string"==typeof f&&n.write(f,o,"utf8"),"byte"===c&&"number"==typeof f&&n.writeUInt8(f,o),"binaryData"===c&&f instanceof Buffer&&f.copy(n,o),o+=l}return n}},{key:"byteLength",value:function(){for(var e=0,r=this.bodies,t=0,n=r.length;t<n;t++){e+=r[t].len}return e}},{key:"body",value:function(){return this.bodies}},{key:"_copyVarInt",value:function(e,r,t){for(var n=0,o=r.length;n<o;n++){var a=r[n];e.writeUInt8(a,t+n)}}},{key:"writeVarIntAsArray",value:function(e,r){for(var t=[],n=0;e>127;n++){var o=128|127&e;t.push(o),e>>=7}if(t.push(e),void 0!==r&&t.length>r)throw new Error("Malformed Remaining Length max size ".concat(r));return t}},{key:"writeVarInt",value:function(e,r){var t=this.writeVarIntAsArray(e,r);this.push({type:"varint",value:t,len:t.length})}},{key:"writeUInt16BE",value:function(e){if(e>65535)throw new Error("too large must be less 65535");this.push({type:"uint16",value:e,len:2})}},{key:"writeUInt32BE",value:function(e){if(e>4294967295)throw new Error("too large must be less 4294967295");this.push({type:"uint32",value:e,len:4})}},{key:"writeUTF8",value:function(e){e=c(e,!1);var r=Buffer.byteLength(e,"utf8");this.writeUInt16BE(r),this.push({type:"utf8",value:e,len:r})}},{key:"writeUTF8NoLength",value:function(e){e=c(e,!1),this.push({type:"utf8",value:e,len:Buffer.byteLength(e,"utf8")})}},{key:"writeBinaryDataNoLength",value:function(e){this.push({type:"binaryData",value:e,len:e.length})}},{key:"writeByte",value:function(e){if(e>255)throw new Error("too large must be less 255");this.push({type:"byte",value:e,len:1})}},{key:"writeBinaryData",value:function(e){var r=(null==e?void 0:e.length)||0;this.writeUInt16BE(r),e&&this.push({type:"binaryData",value:e,len:r})}},{key:"push",value:function(e){this.bodies.push(e)}},{key:"concat",value:function(e){Array.prototype.push.apply(this.bodies,e)}}]),e}(),p=[{key:1,name:"payloadFormatIndicator",format:"boolean"},{key:2,name:"messageExpiryInterval",format:"byteInt4"},{key:3,name:"contentType",format:"utf8"},{key:8,name:"responseTopic",format:"utf8"},{key:9,name:"correlationData",format:"binaryData"},{key:11,name:"subscriptionIdentifier",format:"varInt"},{key:17,name:"sessionExpiryInterval",format:"byteInt4"},{key:18,name:"assignedClientIdentifier",format:"utf8"},{key:19,name:"serverKeepAlive",format:"byteInt2"},{key:21,name:"authenticationMethod",format:"utf8"},{key:22,name:"authenticationData",format:"binaryData"},{key:23,name:"requestProblemInformation",format:"boolean"},{key:24,name:"willDelayInterval",format:"byteInt4"},{key:25,name:"requestResponseInformation",format:"boolean"},{key:26,name:"responseInformation",format:"utf8"},{key:28,name:"serverReference",format:"utf8"},{key:31,name:"reasonString",format:"utf8"},{key:33,name:"receiveMaximum",format:"byteInt2"},{key:34,name:"topicAliasMaximum",format:"byteInt2"},{key:35,name:"topicAlias",format:"byteInt2"},{key:36,name:"maximumQoS",format:"byte"},{key:37,name:"retainAvailable",format:"boolean"},{key:38,name:"userProperties",format:"utf8pair"},{key:39,name:"maximumPacketSize",format:"byteInt4"},{key:40,name:"wildcardSubscriptionAvailable",format:"boolean"},{key:41,name:"subscriptionIdentifiersAvailable",format:"boolean"},{key:42,name:"sharedSubscriptionAvailable",format:"boolean"}],y=p.map((function(e){return e.name})),b=p.reduce((function(e,t){return Object.assign(e,r({},t.name,t)),e}),{}),d=p.reduce((function(e,t){return Object.assign(e,r({},t.key,t)),e}),{}),h={reserved:0,connect:1,connack:2,publish:3,puback:4,pubrec:5,pubrel:6,pubcomp:7,subscribe:8,suback:9,unsubscribe:10,unsuback:11,pingreq:12,pingresp:13,disconnect:14},m=Object.assign(Object.assign({},h),{auth:15}),w=Object.keys(m),v=Object.keys(h);var k=["connect","connack","publish","pubrel","puback","pubrec","pubcomp","subscribe","suback","unsubscribe","unsuback","disconnect","auth"];function g(e,r){var t;if(void 0===(t=3===r?h[e.cmd]:m[e.cmd]))throw new Error("The types of TypePacket does not support");var n=e.qos?e.qos:0,o=e.retain?e.retain:0;return a(t,function(e,r,t,n){if("publish"===e){var o=r?1:0;if(0!==t&&1!==t&&2!==t)throw new Error("qos must be 0 | 1 | 2");return o<<3|t<<1|(n?1:0)}return"pubrel"===e||"subscribe"===e||"unsubscribe"===e?2:0}(e.cmd,!!e.dup,n,!!o),4)}function I(e,r,t,n){e.writeByte(r),e.writeUTF8(t),e.writeUTF8(n)}function B(r,t,n){if(!("utf8pair"!==t.format||"object"!==e(n)||null===n||n instanceof Buffer))for(var o,a=Object.keys(n);o=a.shift();){var i=n[o];if(Array.isArray(i))for(var s=0,u=i.length;s<u;s++){var c=i[s];I(r,t.key,o,c)}"string"==typeof i&&I(r,t.key,o,i)}}function F(e,r,t,n,o){if(!(3===o||k.indexOf(t.cmd)<0))if(void 0!==n){for(var a=Object.keys(n),i=0,s=a.length;i<s;i++){var u=a[i],c=n[u],f=b[u];if(!f)throw new Error("TypeProperties encode error, Does not support properties ".concat(u," only ").concat(y.join(", ")));"utf8"===f.format&&"string"==typeof c&&(r.writeByte(f.key),r.writeUTF8(c)),B(r,f,c),"byte"===f.format&&"number"==typeof c&&(r.writeByte(f.key),r.writeByte(c)),"boolean"===f.format&&"boolean"==typeof c&&(r.writeByte(f.key),r.writeByte(c?1:0)),"byteInt4"===f.format&&"number"==typeof c&&(r.writeByte(f.key),r.writeUInt32BE(c)),"byteInt2"===f.format&&"number"==typeof c&&(r.writeByte(f.key),r.writeUInt16BE(c)),"varInt"===f.format&&"number"==typeof c&&(r.writeByte(f.key),r.writeVarInt(c)),"binaryData"===f.format&&c instanceof Buffer&&(r.writeByte(f.key),r.writeBinaryData(c))}e.writeVarInt(r.byteLength()),e.concat(r.body()),r.bodies=[]}else e.writeByte(0)}function E(e,r){var t,n=e.readForce(),o=function(e){return e>>(arguments.length>1&&void 0!==arguments[1]?arguments[1]:4)}(n),a=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:4;return e&Math.pow(2,r)-1}(n);if(!(t=3===r?v[o]:w[o]))throw new Error("The types of TypePacket does not support");var i=function(e){var r=e>>1&3,t=1&e,n=e>>3;if(0!==n&&1!==n)throw new Error("dup must be 0 | 1");if(0!==r&&1!==r&&2!==r)throw new Error("qos must be 0 | 1 | 2");return{dup:!!n,qos:r,retain:!!t}}(a),s=i.qos,u=i.dup,c=i.retain,f=e.readVarInt(4);if(f!==e.peekMultiple().length)throw new Error("TypePacket length not match");return{length:f,cmd:t,qos:s,dup:u,retain:c}}function U(t,n,o){if(!(3===o||k.indexOf(n)<0)){var a=t.readVarInt();if(a){for(var i={},s=new f(t.multipleForce(a));void 0!==s.peek();){var u=s.readForce(),c=d[u];if(!c)throw new Error("TypeProperties decode error, Does not support properties ".concat(u," only ").concat(y.join(", ")));if("utf8"===c.format&&Object.assign(i,r({},c.name,s.readUTF8())),"utf8pair"===c.format){var l=s.readUTF8(),p=s.readUTF8(),b=i[c.name];if("object"!==e(b)||null===b||b instanceof Buffer)b=r({},l,p);else{var h=b[l];Array.isArray(h)?h.push(p):b[l]="string"==typeof h?[h,p]:p}Object.assign(i,r({},c.name,b))}"byte"===c.format&&Object.assign(i,r({},c.name,s.readForce())),"boolean"===c.format&&Object.assign(i,r({},c.name,!!s.readForce())),"byteInt4"===c.format&&Object.assign(i,r({},c.name,s.readUInt32BE())),"byteInt2"===c.format&&Object.assign(i,r({},c.name,s.readUInt16BE())),"varInt"===c.format&&Object.assign(i,r({},c.name,s.readVarInt())),"binaryData"===c.format&&Object.assign(i,r({},c.name,s.readBinaryBuf()))}return i}}}function T(e,r,t){if(void 0!==e.peek()){var n=r.cmd,o={};if("connect"===n)return function(e,r){var t=e.readUTF8();if("MQTT"!==t&&"MQIsdp"!==t)throw new Error("Protocol Name error");var n=e.readForce();if(5===r&&5!==n)throw new Error("Protocol Version must 5");if(3===r&&4!==n&&3!==n)throw new Error("Protocol Version must 4 | 3");var o=e.readForce();if(0!==i(o,0))throw new Error("Reserved must be 0");return{protocolId:t,protocolVersion:n,clean:!!i(o,1),willFlag:!!i(o,2),willQos:a(i(o,3),i(o,4),2),willRetainFlag:!!i(o,5),passwordFlag:!!i(o,6),usernameFlag:!!i(o,7),keepalive:e.readUInt16BE()}}(e,t);if("connack"===n){var s=e.readForce();o.sessionPresent=!!i(s,0);var u=e.readForce();return o.reasonCode=u,o.returnCode=u,o}if("publish"===n)return o.topic=e.readUTF8(),1!==r.qos&&2!==r.qos||(o.messageId=e.readUInt16BE()),o;if(["puback","pubrec","pubrel","pubcomp"].indexOf(n)>=0){if(o.messageId=e.readUInt16BE(),5===t){var c=e.readForce();o.reasonCode=c,o.returnCode=c}return o}if(["subscribe","suback","unsubscribe","unsuback"].indexOf(n)>=0)return o.messageId=e.readUInt16BE(),o;if(["disconnect","auth"].indexOf(n)>=0&&5===t){var f=e.readForce();return o.reasonCode=f,o.returnCode=f,o}}}exports.Decode=function(e){var r=new f(e),t=E(r,5),n=T(r,t,5),o=U(r,t.cmd,5),s=function(e,r,t,n){var o=e.peek(),s=r.cmd;if(void 0!==o){var u={};if("connect"===s){if(u.clientId=e.readUTF8(),null==t?void 0:t.willFlag){var c={};5===n&&(c.properties=U(e,s,n)),c.topic=e.readUTF8(),c.payload=e.readBinaryBuf(),u.will=c}(null==t?void 0:t.usernameFlag)&&(u.username=e.readUTF8()),(null==t?void 0:t.passwordFlag)&&(u.password=e.readBinaryBuf())}if("publish"===s&&(u.payload=e.multiple()),"subscribe"===s){for(var f=[];void 0!==e.peek();){var l=e.readUTF8(),p=e.readForce(),y=a(i(p,1),i(p,0),2),b=!1,d=!1,h=0;5===n&&(b=!!i(p,2),d=!!i(p,3),h=a(i(p,5),i(p,4),2)),f.push({topic:l,qos:y,nl:b,rap:d,rh:h})}u.subscriptions=f}if("suback"===s||5===n&&"unsuback"===s){for(var m=[];void 0!==e.peek();)m.push(e.readForce());u.granted=m}if("unsubscribe"===s){for(var w=[];void 0!==e.peek();)w.push(e.readUTF8());u.unsubscriptions=w}return u}}(r,t,n,5);return Object.assign(Object.assign(Object.assign(Object.assign({},t),n),s),{properties:o})},exports.DecodeMethod=f,exports.Encode=function(e){var r=new l,t=new l,n=g(e,5);return function(e,r,t){var n=r.cmd;if("connect"===n){var o=r.protocolId||"MQTT";if("MQTT"!==o&&"MQIsdp"!==o)throw new Error("Protocol Name error");var a=r.protocolVersion||(5===t?5:4);if(5===t&&5!==a)throw new Error("Protocol Version must 5");if(3===t&&4!==a&&3!==a)throw new Error("Protocol Version must 4 | 3");e.writeUTF8(o),e.writeByte(a);var i={usernameFlag:r.username?1:0,passwordFlag:r.password?1:0,willRetainFlag:r.willRetainFlag?1:0,willQos:r.willQos?1:0,willFlag:r.will?1:0,clean:r.clean?1:0};s("willQos",i,2),s("usernameFlag",i),s("passwordFlag",i),s("willRetainFlag",i),s("willFlag",i),s("clean",i);var u=i.usernameFlag<<7|i.passwordFlag<<6|i.willRetainFlag<<5|i.willQos<<3|i.willFlag<<2|i.clean<<1;e.writeByte(u),e.writeUInt16BE(r.keepalive||0)}if("connack"===n&&(e.writeByte(r.sessionPresent?1:0),e.writeByte(r.returnCode||r.reasonCode||0)),"publish"===n){if(void 0===r.topic)throw new Error("topic must be set");if(e.writeUTF8(r.topic),1===r.qos||2===r.qos){if(void 0===r.messageId)throw new Error("must be set messageId");e.writeUInt16BE(r.messageId)}}if(["puback","pubrec","pubrel","pubcomp"].indexOf(n)>=0){if(void 0===r.messageId)throw new Error("must be set messageId");e.writeUInt16BE(r.messageId),5===t&&e.writeByte(r.returnCode||r.reasonCode||0)}if(["subscribe","suback","unsubscribe","unsuback"].indexOf(n)>=0){if(void 0===r.messageId)throw new Error("must be set messageId");e.writeUInt16BE(r.messageId)}["disconnect","auth"].indexOf(n)>=0&&5===t&&e.writeByte(r.returnCode||r.reasonCode||0)}(r,e,5),F(r,t,e,e.properties,5),function(e,r,t,n){var o=t.cmd;if("connect"===o){if(!t.clientId)throw new Error("payload.clientId must be set");e.writeUTF8(t.clientId);var a=t.will;void 0!==a&&(5===n&&F(e,r,t,a.properties,n),e.writeUTF8(a.topic||""),e.writeBinaryData(a.payload)),t.username&&e.writeUTF8(t.username),t.password&&e.writeBinaryData(t.password)}if("publish"===o&&(t.payload instanceof Buffer&&e.writeBinaryDataNoLength(t.payload),"string"==typeof t.payload&&e.writeUTF8NoLength(t.payload)),"subscribe"===o)for(var i=t.subscriptions||[],u=0,c=i.length;u<c;u++){var f=i[u];if(!f.topic)throw new Error("topic must be set");e.writeUTF8(f.topic);var l={rh:0,rap:0,nl:0,qos:f.qos||0};s("qos",l,2),5===n&&(l.rh=f.rh?1:0,l.rap=f.rap?1:0,l.nl=f.nl?1:0,s("rh",l),s("rap",l),s("nl",l));var p=l.rh<<4|l.rap<<3|l.nl<<2|l.qos;e.writeByte(p)}if("suback"===o||"unsuback"===o&&5===n)for(var y=t.granted||[],b=0,d=y.length;b<d;b++){var h=y[b];e.writeByte(h)}if("unsubscribe"===o)for(var m=t.unsubscriptions||[],w=m.length,v=0;v<w;v++){var k=m[v];e.writeUTF8(k)}}(r,t,e,5),r.result(n)},exports.EncodeMethod=l;
//# sourceMappingURL=node.v6.min.js.map
